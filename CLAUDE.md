# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

VIS PPDB (Penerimaan Peserta Didik Baru) — a multi-tenant online student admission & enrollment system for Veritas Intercultural School (3 campuses: Bintaro, Kelapa Gading, Bali). Built with Laravel 12 + Filament 5.

## Common Commands

```bash
# Setup from scratch
composer run setup

# Development (starts Artisan, queue worker, and Vite concurrently)
composer run dev

# Run all tests (SQLite in-memory)
composer run test
# or
./vendor/bin/pest

# Lint / format PHP
vendor/bin/pint

# Build frontend assets
npm run build
```

Individual dev commands if needed:
```bash
php artisan serve
php artisan queue:listen --tries=1
npm run dev
```

## Architecture

### Two-Panel Filament Setup

| Panel | Path | Scope |
|-------|------|-------|
| **SuperAdmin** | `/superadmin` | Global — school & user management |
| **School** | `/school/s/{school-code}` | Tenant-scoped — all admission operations |

Panel providers live in `app/Providers/Filament/`:
- `SchoolPanelProvider.php` — configures multi-tenancy via `->tenant(School::class, 'code')`
- `SuperAdminPanelProvider.php` — default panel, no tenancy

### Multi-Tenancy

The `School` model is the tenant. All school-scoped data carries a `school_id` FK. The URL segment `{school-code}` is the tenant identifier. `FilamentShield` is configured with `->scopeToTenant(true)` so permissions are per-school.

The `User` model implements `FilamentUser`, `HasDefaultTenant`, and `HasTenants`. Access control is in `canAccessPanel()`. Helper methods: `isSuperAdmin()`, `isAdmissionAdmin()`, `isFinanceAdmin()`, etc.

### Application Workflow (Core Domain)

Status flow: `draft → submitted → under_review → {observation/test/interview_scheduled} → accepted / rejected → enrolled`

Payment stages: `pre_submission` (Saving Seat, 2.5M IDR) → `post_acceptance` (full payment).

Application numbers are auto-generated on creation: `{SCHOOL_CODE}-{YEAR}-{SEQUENCE}` (e.g., `VIS-2024-0001`).

### Filament Resource Structure

Resources are in `app/Filament/School/Resources/` and follow this pattern:

```
Resources/{Name}/
├── {Name}Resource.php          # Main resource class
├── Pages/                      # List, Create, Edit, View
├── RelationManagers/           # Nested CRUD (Parents, Documents, Payments, Schedules)
├── Schemas/                    # Extracted form / infolist / table schema classes
└── Widgets/                    # Stats, charts (used on Dashboard)
```

Schema logic is extracted into `Schemas/` classes to keep resource files clean and enable reuse.

### Roles (via FilamentShield + Spatie Permission)

`super_admin`, `school_admin`, `admission_admin`, `finance_admin`, `panel_user`

Custom Permission/Role models are registered in `AppServiceProvider`. Policy files are auto-generated by FilamentShield in `app/Policies/`.

### Key Models

| Model | Notes |
|-------|-------|
| `School` | Tenant — `code` is the URL slug |
| `Application` | Core entity — tracks the full admission journey |
| `User` | Staff + parents, multi-role, scoped to school |
| `Payment` / `PaymentType` | Two stages (pre/post submission) |
| `Enrollment` | Created when application is accepted + paid |
| `Schedule` | Observation / test / interview appointments |
| `Setting` | Singleton system config |
| `ActivityLog` | Audit trail |

All core models use `SoftDeletes`. `applications` table has a full-text index on student names and application number.

### Database

MySQL in production, SQLite in-memory for tests (`phpunit.xml`). Session, cache, and queue use the `database` driver by default.

```bash
php artisan migrate
php artisan migrate:refresh --seed
php artisan tinker
```
